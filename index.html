<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YenMozhi — Voice Recognition & Avatar</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

    <style>
      :root {
        --bg: #0f1720;
        --card: #111318;
        --accent: #00e676;
        --muted: #9aa0a6;
        --glass: rgba(255, 255, 255, 0.03);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 18px;
        padding: 36px;
        background: linear-gradient(180deg, #07101a 0%, #09121a 100%);
        color: #e6eef6;
        font-family: Inter, "Segoe UI", system-ui, -apple-system,
          "Helvetica Neue", Arial;
        align-items: center;
      }

      /* Container to center content */
      .container {
        width: 100%;
        max-width: 1000px;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      /* Header */
      header {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 18px;
        width: 100%;
      }
      .logo {
        width: 100px;
        height: 100px;
        border-radius: 12px;
        object-fit: cover;
      }
      .header-text {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .header-text h1 {
        margin: 0;
        font-size: 28px;
        color: var(--accent);
        font-weight: 700;
      }
      .header-text p.sub {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
        line-height: 1.4;
      }

      /* Controls */
      .controls {
        display: flex;
        gap: 12px;
        align-items: center;
        width: 100%;
      }
      button.primary {
        background: var(--accent);
        border: none;
        padding: 10px 18px;
        border-radius: 10px;
        font-weight: 700;
        color: #000;
        cursor: pointer;
        box-shadow: 0 6px 18px rgba(0, 230, 118, 0.12);
        transition: transform 0.12s ease;
      }
      button.primary:active {
        transform: translateY(1px);
      }
      button.ghost {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.06);
        padding: 8px 12px;
        border-radius: 10px;
        color: var(--muted);
        cursor: pointer;
      }

      /* Layout */
      .layout {
        display: flex;
        gap: 24px;
        width: 100%;
        height: 80vh;
        align-items: flex-start;
        justify-content: center;
        flex-wrap: wrap;
      }
      .left {
        flex: 1;
        min-width: 300px;
        background: var(--card);
        border-radius: 14px;
        padding: 18px;
        box-shadow: 0 6px 30px rgba(4, 8, 12, 0.6);
      }
      .right {
        width: 320px;
        min-width: 300px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: center;
        background: var(--card);
        border-radius: 14px;
        padding: 18px;
        box-shadow: 0 6px 30px rgba(4, 8, 12, 0.6);
      }

      /* Labels */
      #label-container {
        display: grid;
        grid-template-columns: 1fr 80px;
        gap: 8px;
        align-items: center;
      }
      .label-name {
        font-size: 14px;
        color: #cfe7db;
      }
      .label-bar {
        height: 8px;
        background: var(--glass);
        border-radius: 6px;
        overflow: hidden;
        position: relative;
      }
      .label-fill {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 0%;
        background: linear-gradient(90deg, var(--accent), #ffd600);
        border-radius: 6px;
        transition: width 150ms linear;
      }
      #top-label {
        margin-top: 16px;
        width: 100%;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        padding: 18px;
        border-radius: 12px;
        text-align: center;
        font-size: 28px;
        font-weight: 700;
        color: #fff;
        box-shadow: 0 10px 30px rgba(2, 6, 10, 0.6);
        transition: transform 0.22s cubic-bezier(0.2, 0.9, 0.3, 1),
          box-shadow 0.22s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      #top-label.pulse {
        transform: scale(1.05);
        box-shadow: 0 18px 40px rgba(0, 230, 118, 0.12);
      }
      #confidence-small {
        font-size: 13px;
        color: var(--muted);
      }

      /* Avatar */
      .avatar-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        padding: 14px;
      }
      .avatar {
        width: 180px;
        height: 180px;
        border-radius: 14px;
        background: linear-gradient(180deg, #0b0f12, #0d1216);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 12px 40px rgba(2, 6, 10, 0.6);
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease;
      }
      .avatar.speaking {
        transform: scale(1.2);
      }
      .mouth {
        transform-origin: center;
        transition: transform 0.08s linear;
      }
      .talking .mouth {
        animation: mouthOpen 160ms infinite linear;
      }
      @keyframes mouthOpen {
        0% {
          transform: scaleY(1);
        }
        50% {
          transform: scaleY(0.25);
        }
        100% {
          transform: scaleY(1);
        }
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--muted);
      }
      .status-dot.listening {
        background: var(--accent);
        box-shadow: 0 6px 18px rgba(0, 230, 118, 0.08);
      }

      /* Sections */
      section {
        background: var(--card);
        padding: 18px;
        border-radius: 14px;
        box-shadow: 0 6px 30px rgba(4, 8, 12, 0.6);
        width: 100%;
        margin-top: 18px;
      }
      section h2 {
        margin-top: 0;
        color: var(--accent);
      }
      section p {
        color: #cfe7db;
        line-height: 1.5;
        margin-bottom: 12px;
      }
      .product-images {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
      }
      .product-images img {
        width: 150px;
        border-radius: 12px;
        object-fit: cover;
      }

      /* Footer */
      footer {
        background: var(--card);
        padding: 18px;
        border-radius: 14px;
        box-shadow: 0 6px 30px rgba(4, 8, 12, 0.6);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        color: var(--muted);
        font-size: 14px;
        width: 100%;
        max-width: 1000px;
      }
      footer a {
        color: var(--accent);
        text-decoration: none;
        font-weight: 600;
      }
      footer a:hover {
        text-decoration: underline;
      }
      footer .line {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      /* Responsive */
      @media (max-width: 860px) {
        .layout {
          flex-direction: column;
          align-items: center;
        }
        .right {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <img src="assets/YenMozhi.png" alt="YenMozhi Logo" class="logo" />
        <div
          class="header-text"
          style="width: 100%; align-items: center; text-align: center"
        >
          <h1 style="width: 100%; text-align: center; margin: 0 auto">
            YenMozhi
          </h1>
          <p
            class="sub"
            style="width: 100%; text-align: center; margin: 0 auto"
          >
            Giving a voice to interact with the World.!
          </p>
        </div>
      </header>

      <div class="controls">
        <button class="primary" id="btnStart">Start Listening</button>
        <button class="ghost" id="btnStop">Stop</button>
        <div
          style="
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 8px;
          "
        >
          <div class="status-dot" id="statusDot"></div>
          <div style="font-size: 13px; color: var(--muted)">Microphone</div>
        </div>
      </div>

      <div class="layout">
        <div class="left">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div style="font-size: 15px; color: var(--muted)">
              Live class confidences
            </div>
            <div style="font-size: 12px; color: var(--muted)">
              Threshold: <span id="thrLabel">0.75</span>
            </div>
          </div>
          <div id="label-container" style="margin-top: 12px"></div>
          <div id="top-label" style="margin-top: 18px">
            <div id="topText">Waiting for input...</div>
            <div id="confidence-small">—</div>
          </div>
        </div>

        <div class="right">
          <div class="avatar-wrap">
            <img
              src="assets/YenMozhi Use.png"
              alt="Avatar"
              class="avatar"
              id="avatar"
            />
            <div style="text-align: center">
              <div id="speakText" style="font-weight: 700"></div>
              <div
                style="font-size: 13px; color: var(--muted); margin-top: 6px"
              >
                Avatar
              </div>
            </div>
          </div>

          <div style="width: 100%; text-align: center; margin-top: 8px">
            <label style="font-size: 13px; color: var(--muted)">Voice</label>
            <select
              id="voiceSelect"
              style="
                width: 100%;
                margin-top: 6px;
                padding: 8px;
                border-radius: 8px;
                background: #222;
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: #fff;
              "
            ></select>
          </div>
        </div>
      </div>

      <section id="about">
        <h2>About YenMozhi</h2>
        <h3>🌟 YenMozhi – Empowering Silent Voices</h3>
        <p>
          YenMozhi is more than a project—it is a lifeline, a spark of hope for
          those whose voices have long been unheard. In a world where
          communication is the bridge to connection, countless individuals,
          especially children with Autism Spectrum Disorder (ASD) or speech
          challenges, struggle silently.
        </p>
        <h3>🧩 The Silent Struggle</h3>
        <p>
          Imagine a child who has never spoken a single word since birth, living
          in a world where expressing feelings, asking for help, or simply
          connecting with others seems impossible. For millions like them, every
          day is a silent battle, filled with frustration, isolation, and
          untapped potential.
        </p>
        <h3>📊 The Need</h3>
        <p>
          In India alone, millions of children face such communication barriers,
          and without proper tools, guidance, and support, their voices remain
          trapped within. YenMozhi exists to break these barriers—to transform
          silence into speech, hesitation into confidence, and isolation into
          connection.
        </p>
        <h3>💡 How YenMozhi Helps</h3>
        <p>
          Through perseverance, creativity, and cutting-edge technology,
          YenMozhi empowers individuals to interact with the world around them,
          giving them the priceless gift of expression. Every word spoken, every
          idea shared, every emotion conveyed is a triumph—a step toward
          independence, self-confidence, and inclusion.
        </p>
        <h3>🌱 A Message of Hope</h3>
        <p>
          This project stands as a testament to hope, determination, and the
          profound power of human connection. It reminds us that every
          individual, no matter their challenges, deserves a chance to be heard
          and understood.
        </p>
        <h4>Giving a voice to interact with the world.</h4>
      </section>

      <section id="product-images">
        <h2>Product Samples</h2>
        <div class="product-images">
          <img
            src="assets/YenMozhi Device 1.png"
            alt="Sample 1"
            style="width: 220px"
          />
          <img
            src="assets/YenMozhi Device 2.png"
            alt="Sample 2"
            style="width: 220px"
          />
          <img
            src="assets/YenMozhi Use.png"
            alt="Sample 3"
            style="width: 220px"
          />
        </div>
      </section>

      <footer style="align-items: center; text-align: center">
        <div>
          <a
            href="https://www.linkedin.com/in/sasikumar-0208-r"
            target="_blank"
            style="
              color: var(--accent);
              font-weight: 700;
              text-decoration: none;
            "
          >
            Sasikumar R
          </a>
        </div>
        <div>Founder and CEO, Symphonix</div>
        <div>6369196110 | sasirajkumar7rs@gmail.com</div>
        <div class="line" style="justify-content: center">
          <a href="https://buildwithsasi.web.app" target="_blank">Portfolio</a>
          |
          <a href="https://www.linkedin.com/in/sasikumar-0208-r" target="_blank"
            >LinkedIn</a
          >
        </div>
        <div>Project: YenMozhi | Built by Sasikumar R</div>
      </footer>

      <script>
        // --- Existing YenMozhi code remains unchanged ---
        // Voice & ML model script remains same as previous code
        const MODEL_URL =
          "https://teachablemachine.withgoogle.com/models/GmzaS6iNB/";
        let recognizer = null;
        let classLabels = [];
        let threshold = 0.75;
        let lastSpoken = "";
        let lastSpokenTime = 0;
        const cooldown = 1600;

        const btnStart = document.getElementById("btnStart");
        const btnStop = document.getElementById("btnStop");
        const statusDot = document.getElementById("statusDot");
        const labelContainer = document.getElementById("label-container");
        const topLabel = document.getElementById("top-label");
        const topText = document.getElementById("topText");
        const confSmall = document.getElementById("confidence-small");
        const avatar = document.getElementById("avatar");
        const speakText = document.getElementById("speakText");
        const voiceSelect = document.getElementById("voiceSelect");
        document.getElementById("thrLabel").innerText = threshold;

        let voices = [];
        function populateVoices() {
          voices = speechSynthesis.getVoices() || [];
          voiceSelect.innerHTML = "";
          voices.forEach((v, i) => {
            if (
              v.lang.toLowerCase().includes("en") ||
              v.lang.toLowerCase().includes("ta") ||
              v.lang.toLowerCase().includes("ml")
            ) {
              const opt = document.createElement("option");
              opt.value = i;
              opt.innerText = `${v.name} (${v.lang})`;
              voiceSelect.appendChild(opt);
            }
          });
        }
        window.speechSynthesis.onvoiceschanged = populateVoices;

        function speak(text) {
          if (!("speechSynthesis" in window)) return;
          const now = Date.now();
          if (now - lastSpokenTime < cooldown && text === lastSpoken) return;

          const ut = new SpeechSynthesisUtterance(text);
          const selected = voiceSelect.value;
          if (voices.length && selected !== "") ut.voice = voices[selected];
          ut.pitch = 1;
          ut.rate = 1;
          ut.volume = 1;

          avatar.classList.add("speaking");
          speakText.innerText = text;

          ut.onend = () => {
            avatar.classList.remove("speaking");
            setTimeout(() => {
              if (speakText.innerText === text) speakText.innerText = "";
            }, 400);
          };
          speechSynthesis.cancel();
          speechSynthesis.speak(ut);

          lastSpoken = text;
          lastSpokenTime = now;
        }

        async function createModel() {
          const checkpointURL = MODEL_URL + "model.json";
          const metadataURL = MODEL_URL + "metadata.json";
          const rec = speechCommands.create(
            "BROWSER_FFT",
            undefined,
            checkpointURL,
            metadataURL
          );
          await rec.ensureModelLoaded();
          return rec;
        }

        function buildLabelUI(labels) {
          labelContainer.innerHTML = "";
          labels.forEach((lbl, i) => {
            const name = document.createElement("div");
            name.className = "label-name";
            name.innerText = lbl;
            const barWrap = document.createElement("div");
            barWrap.className = "label-bar";
            const fill = document.createElement("div");
            fill.className = "label-fill";
            fill.id = "fill-" + i;
            barWrap.appendChild(fill);
            labelContainer.appendChild(name);
            labelContainer.appendChild(barWrap);
          });
        }

        async function startListening() {
          try {
            if (!recognizer) {
              recognizer = await createModel();
              classLabels = recognizer.wordLabels();
              buildLabelUI(classLabels);
            }

            recognizer.listen(
              (result) => {
                const scores = result.scores;
                let maxIdx = 0,
                  maxVal = -1;
                for (let i = 0; i < scores.length; i++) {
                  const val = scores[i];
                  const fillEl = document.getElementById("fill-" + i);
                  if (fillEl)
                    fillEl.style.width =
                      Math.max(0, Math.min(100, val * 100)) + "%";
                  if (val > maxVal) {
                    maxVal = val;
                    maxIdx = i;
                  }
                }
                topText.innerText = `${classLabels[maxIdx]}`;
                confSmall.innerText = `${(maxVal * 100).toFixed(2)}%`;
                topLabel.classList.add("pulse");
                setTimeout(() => topLabel.classList.remove("pulse"), 280);

                if (maxVal >= threshold) {
                  const labelToSpeak = classLabels[maxIdx];
                  if (
                    labelToSpeak !== lastSpoken ||
                    Date.now() - lastSpokenTime > cooldown
                  ) {
                    speak(labelToSpeak);
                  }
                }
              },
              {
                includeSpectrogram: true,
                probabilityThreshold: 0.01,
                overlapFactor: 0.5,
                invokeCallbackOnNoiseAndUnknown: true,
              }
            );

            statusDot.classList.add("listening");
          } catch (err) {
            console.error("Model error:", err);
            alert("Failed to load model. Check console.");
          }
        }

        function stopListening() {
          if (recognizer) recognizer.stopListening();
          statusDot.classList.remove("listening");
          avatar.classList.remove("speaking");
          speakText.innerText = "";
        }

        btnStart.addEventListener("click", async () => {
          populateVoices();
          await startListening();
        });
        btnStop.addEventListener("click", stopListening);

        populateVoices();

        // --- NEW: Mic state follower ---
        window.__micRunning = false;

        async function syncMicState() {
          try {
            const res = await fetch("/api/state", { cache: "no-store" });
            const { micState } = await res.json();
            const shouldRun = micState === "on";

            if (shouldRun && !window.__micRunning) {
              await startListening();
              window.__micRunning = true;
              console.log("[YenMozhi] Mic ON");
            } else if (!shouldRun && window.__micRunning) {
              stopListening();
              window.__micRunning = false;
              console.log("[YenMozhi] Mic OFF");
            }
          } catch (e) {
            console.warn("[YenMozhi] state check failed", e);
          }
        }

        // Poll the backend once a second
        setInterval(syncMicState, 1000);
        syncMicState();
      </script>
    </div>
  </body>
</html>
